### Setup----
# Dependencies
if (!require(needs)) {install.packages("needs"); library(needs)}
if (!require(goallabr)) {
  if (!require(devtools)) {install.packages("devtools"); library(devtools)}
  install_github("chrisharrisUU/goallabr")
}
needs(dplyr, magrittr, ggplot2, car, here, tidyr, gridExtra, BayesFactor, papaja, purrr, gridExtra, goallabr)
prioritize(dplyr)

source(here("Auxiliary/Exp2_init.R"))

### Functions----
source(here("Auxiliary/functions.R"))

### Canonical sorting----
df2 <- do_counterbalance_2(df2)

# Include switching
df2 <- switching(df2, 17)

# Make preference binary
df2 %<>%
  mutate(binaryprepref = ifelse(prepref_dom > 0,
                                1,
                                ifelse(prepref_dom < 0, 0, NA)),
         binarypostpref = ifelse(postpref_dom > 0,
                                 1,
                                 ifelse(postpref_dom < 0, 0, NA))) %>%
  mutate(binarypostpref = factor(binarypostpref, levels = c(1, 0)),
         binaryprepref = factor(binaryprepref, levels = c(1, 0)))

### Demographic data----
# Summary of most relevant demographic data
df2 %>%
  mutate(age = as.integer(as.character(age))) %>%
  summarise(N = n(),
            female = length(which(gender == "female")),
            age_mean = mean(age, na.rm = TRUE),
            age_sd = sd(age, na.rm = TRUE))

# Level of education
df2 %>%
  group_by(edu) %>%
  summarise(count = length(edu))
# Percentage degree
length(which(as.integer(df2$edu) > 2)) / nrow(df2)

### Relative preference estimates pre----

## Continuous
# Graph
df2 %>%
  ggplot(aes(x = condition,
             y = prepref_freq,
             fill = condition)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Condition",
       y = "Relative preference estimates - pre-measure")

# Means and sds
df2 %>%
  group_by(condition) %>%
  summarise(post_avg = printnum(mean(prepref_freq)),
            post_SD = printnum(sd(prepref_freq)))

# Tests
df2 %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = prepref_freq ~ condition,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df2,
      y = prepref_freq,
      x = condition,
      dir = "two.sided")

ttestBF(
  df2$prepref_freq,
  mu = 0,
  nullInterval = c(0, Inf)
) %>% printBFt()
ttest(data = df2,
      y = prepref_freq,
      x = condition,
      mu = 0,
      dir = "greater")

## Binary
# Distribution
distrpre <- df2 %$%
  table(binaryprepref, condition)
distrpre
length(which(is.na(df2$binaryprepref))) # excluded from binary analyses

# Tests
proportionBF(y = distrpre["1", "rich"],
             N = distrpre["1", "rich"] + distrpre["0", "rich"],
             p = distrpre["0", "impoverished"] / (distrpre["1", "impoverished"] + distrpre["0", "impoverished"]),
             rscale = "ultrawide",
             nullInterval = c(0, 1)) %>% printBFb()
binom.test(x = distrpre["1", "rich"],
           n = distrpre["1", "rich"] + distrpre["0", "rich"],
           p = distrpre["0", "impoverished"] / (distrpre["1", "impoverished"] + distrpre["0", "impoverished"]),
           alternative = "greater")

proportionBF(y = distrpre["1", "rich"] + distrpre["0", "impoverished"],
             N = distrpre["1", "rich"] + distrpre["0", "rich"] + distrpre["1", "impoverished"] + distrpre["0", "impoverished"],
             p = .5,
             rscale = "ultrawide",
             nullInterval = c(0, 1)) %>% printBFb()
binom.test(x = distrpre["1", "rich"] + distrpre["0", "impoverished"],
           n = distrpre["1", "rich"] + distrpre["0", "rich"] + distrpre["1", "impoverished"] + distrpre["0", "impoverished"],
           p = .5,
           alternative = "greater")

### Conditionals pre----
# Graph
df2 %>%
  ggplot(aes(x = condition,
             y = precond_dp,
             fill = condition)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Conditional estimates",
       y = expression(Delta*"p"))

# Summary statistics and tests
df2 %>%
  # xprecond2 -> How likely was it (in %) that you grabbed a *frequent* ball if...
  mutate(frequent = ifelse(primacy == "A", aprecond2, bprecond2),
         infrequent = ifelse(primacy == "A", bprecond2, aprecond2)) %>%
  # Summarize
  # group_by(condition) %>%
  summarize(pre_winning_rich = printnum(mean(frequent)),
            pre_losing_rich = printnum(mean(infrequent)),
            winning_bag_sd = printnum(sd(frequent)),
            losing_bag_sd = printnum(sd(infrequent)))

df2 %>%
  # group_by(condition) %>%
  summarize(post_avg = printnum(mean(precond_dp)),
            post_SD = printnum(sd(precond_dp)))

# Tests
df2 %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = precond_dp ~ condition,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df2,
      y = precond_dp,
      x = condition,
      dir = "two.sided")

ttestBF(df2$precond_dp, mu = 0, nullInterval = c(0, Inf)) %>% printBFt()
ttest(data = df2,
      y = precond_dp,
      x = condition,
      mu = 0,
      dir = "greater")

### Confidence pre ----

# Inference tests
conf <- df2 %>%
  group_by(condition) %>%
  mutate(conf_pre_fr = ifelse(primacy == "A", apreconf2, bpreconf2),
         conf_pre_in = ifelse(primacy == "A", bpreconf2, apreconf2)) %>%
  ungroup %>%
  select(condition, conf_pre_fr, conf_pre_in) %>%
  pivot_longer(df = .,
               cols = c(conf_pre_fr, conf_pre_in),
               names_to = "type",
               values_to = "confidence")
conf %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)

# Per condition
conf %>%
  filter(condition == "rich") %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  filter(condition == "rich") %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  filter(condition == "rich") %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)

conf %>%
  filter(condition == "impoverished") %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  filter(condition == "impoverished") %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  filter(condition == "impoverished") %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)
### Sampling----

## Aggregated over trials per participant

# Graph
p <- arrangeGrob(
  df2 %>%
    ggplot(aes(x = condition,
               y = choiceindex_per,
               fill = condition)) +
    geom_boxplot() +
    scale_fill_brewer(palette = "Dark2") +
    theme_apa() +
    labs(x = " ",
         y = "Percentage frequent option over participants") +
    guides(fill = FALSE) +
    lims(y = c(0, 1)),
  prep(df2) %>%
    ggplot(aes(x = condition,
               y = sampling,
               fill = condition)) +
    geom_boxplot() +
    scale_fill_brewer(palette = "Dark2") +
    theme_apa() +
    labs(x = " ",
         y = "Percentage frequent option over trials") +
    lims(y = c(0, 1)),
  nrow = 1,
  layout_matrix = matrix(c(1, 1, 1, 1, 2, 2, 2, 2, 2), nrow = 1))
ggsave(filename = "Output/Graphs/Exp2_sampling.svg",
       plot = p,
       device = "svg") # 9.08 x 5.72

# Means and sds
df2 %>%
  group_by(condition) %>%
  summarise(post_avg = printnum(100 * mean(choiceindex_per)),
            post_SD = printnum(100 * sd(choiceindex_per)))

# Tests
df2 %>%
  filter(condition == "rich") %>%
  as.data.frame() %$%
  ttestBF(choiceindex_per,
          mu = .5,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2,
      y = choiceindex_per,
      x = condition,
      mu = .5,
      sub = "rich",
      dir = "greater")

df2 %>%
  filter(condition == "impoverished") %>%
  as.data.frame() %$%
  ttestBF(choiceindex_per,
          mu = .5,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df2,
      y = choiceindex_per,
      x = condition,
      mu = .5,
      sub = "impoverished",
      dir = "two.sided")

df2 %>%
  mutate(choiceindex_per = ifelse(condition == "rich", choiceindex_per, 1 - choiceindex_per)) %>%
  as.data.frame() %>%
  ttestBF(data = .,
          formula = choiceindex_per ~ condition,
          nullInterval = c(0, Inf)) %>%
  printBFt()
df2 %>%
  mutate(choiceindex_per = ifelse(condition == "rich", choiceindex_per, 1 - choiceindex_per)) %>%
  ttest(data = .,
      y = choiceindex_per,
      x = condition,
      dir = "greater")

## Aggregated over participants per trial

# Graph
time_series(df2)
ggsave("Output/Graphs/Exp2_timeseries.svg", device = "svg")

# Means and sds
df2 %>%
  prep() %>%
  group_by(condition) %>%
  summarize(avg = printnum(100 * mean(sampling)),
            sd = printnum(100 * sd(sampling)))

# Test
df2 %>%
  prep() %>%
  mutate(sampling = ifelse(condition == "rich", sampling, 1 - sampling)) %>%
  as.data.frame() %>%
  ttestBF(data = .,
          formula = sampling ~ condition,
          nullInterval = c(0, Inf)) %>%
  printBFt()
df2 %>%
  prep() %>%
  mutate(sampling = ifelse(condition == "rich", sampling, 1 - sampling)) %>%
  ttest(data = .,
      y = sampling,
      x = condition,
      dir = "greater")

# Oscillation
oscillations(df2) %>%
  group_by(condition) %>%
  summarize(avg = 100 * mean(oscillation),
            sd = 100 * sd(oscillation))

oscillations(df2) %>%
  ggplot(aes(x = time,
             y = oscillation,
             color = condition)) +
  geom_point(size = .9) +
  geom_line(size = .2,
            alpha = .3) +
  geom_smooth(method = "loess",
              span = 1,
              size = 1) +
  scale_color_brewer(palette = "Dark2") +
  theme_apa() +
  labs(y = "Percentage switches",
       x = "Trial")
ggsave("Output/Graphs/Exp2_oscillations.svg", device = "svg")

# Test
ttestBF(subset(oscillations(df2), condition == "impoverished")$oscillation,
        subset(oscillations(df2), condition == "rich")$oscillation,
        nullInterval = c(0, Inf)) %>%
  printBFt()
df2 %>%
  oscillations() %>%
  mutate(condition = factor(condition, levels = c("impoverished", "rich"))) %>%
  ttest(data = .,
        y = oscillation,
        x = condition,
        dir = "greater")

### Relative preference estimates post----

## Continuous

# Graph
df2 %>%
  ggplot(aes(x = condition,
             y = postpref_freq,
             fill = condition)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Condition",
       y = "Relative preference estimates - post-measure")

# Means and sds
df2 %>%
  group_by(condition) %>%
  summarise(post_avg = printnum(mean(postpref_freq)),
            post_SD = printnum(sd(postpref_freq)))

# Tests
df2 %>%
  filter(condition == "rich") %>%
  as.data.frame() %$%
  ttestBF(postpref_freq,
          mu = 0,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2,
      y = postpref_freq,
      x = condition,
      mu = 0,
      sub = "rich",
      dir = "greater")

df2 %>%
  filter(condition == "impoverished") %>%
  as.data.frame() %$%
  ttestBF(postpref_freq,
          mu = 0,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df2,
      y = postpref_freq,
      x = condition,
      mu = 0,
      sub = "impoverished",
      dir = "two.sided")

df2 %>%
  as.data.frame() %>%
  ttestBF(data = .,
          formula = postpref_freq ~ condition,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2,
      y = postpref_freq,
      x = condition,
      dir = "greater")

# Graph
df2 %>%
  gather(key = time,
         value = polarity,
         c(prepref_freq, postpref_freq)) %>%
  mutate(time = factor(time,
                       levels = c("prepref_freq", "postpref_freq"),
                       labels = c("pre", "post"))) %>%
  within_ci(.data = .,
             .subject = participant.id,
             .value = polarity,
             .ws_factors = time,
             .bs_factors = condition) %>%
  ggplot(aes(color = condition)) +
  geom_point(aes(x = time,
                 y = sample_mean)) +
  geom_line(aes(x = time,
                y = sample_mean,
                group = condition),
            size = .9) +
  geom_errorbar(width = .1,
                aes(x = time,
                    ymin = sample_mean - CI,
                    ymax = sample_mean + CI)) +
  scale_color_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Measurement point",
       y = "Relative preference estimates")
ggsave("Output/Graphs/Exp2_relprefest.svg", device = "svg")

## Binary

# Graph
df2 %>%
  filter(!is.na(binarypostpref)) %>%
  mutate(binarypostpref = factor(binarypostpref)) %>%
  ggplot(aes(x = binarypostpref,
             group = condition,
             fill = condition)) +
  geom_bar(position = "dodge") +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa()


# Distribution
distrpost <- df2 %$%
  table(binarypostpref, condition)
distrpost
length(which(is.na(df2$binarypostpref))) # excluded from binary analyses

# Tests
proportionBF(y = distrpost["1", "rich"],
             N = distrpost["1", "rich"] + distrpost["0", "rich"],
             p = .5,
             rscale = "ultrawide",
             nullInterval = c(.5, 1)) %>% printBFb
binom.test(x = distrpost["1", "rich"],
           n = distrpost["1", "rich"] + distrpost["0", "rich"],
           p = .5,
           alternative = "greater")

proportionBF(y = distrpost["0", "impoverished"],
             N = distrpost["1", "impoverished"] + distrpost["0", "impoverished"],
             p = .5,
             rscale = "ultrawide",
             nullInterval = c(0, 1)) %>% printBFb
binom.test(x = distrpost["0", "impoverished"],
           n = distrpost["1", "impoverished"] + distrpost["0", "impoverished"],
           p = .5,
           alternative = "greater")

proportionBF(y = distrpost["1", "rich"],
             N = distrpost["1", "rich"] + distrpost["0", "rich"],
             p = distrpost["0", "impoverished"] / (distrpost["1", "impoverished"] + distrpost["0", "impoverished"]),
             rscale = "ultrawide",
             nullInterval = c(.5, 1)) %>% printBFb()
binom.test(x = distrpost["1", "rich"],
           n = distrpost["1", "rich"] + distrpost["0", "rich"],
           p = distrpost["0", "impoverished"] / (distrpost["1", "impoverished"] + distrpost["0", "impoverished"]),
           alternative = "greater")


### Conditionals post----

# Graph
df2 %>%
  ggplot(aes(x = condition,
             y = postcond_dp,
             fill = condition)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Conditional estimates",
       y = expression(Delta*"p"))

# Summary statistics and tests
df2 %>%
  # xpostcond2 -> How likely was it (in %) that you grabbed a *frequent* ball if...
  mutate(frequent = ifelse(primacy == "A", apostcond2, bpostcond2),
         infrequent = ifelse(primacy == "A", bpostcond2, apostcond2)) %>%
  # Summarize
  group_by(condition) %>%
  summarise(winning_bag = printnum(mean(frequent)),
            losing_bag = printnum(mean(infrequent)),
            winning_bag_sd = printnum(sd(frequent)),
            losing_bag_sd = printnum(sd(infrequent)))

df2 %>%
  group_by(condition) %>%
  summarise(post_avg = printnum(mean(postcond_dp)),
            post_SD = printnum(sd(postcond_dp)))

# Tests
df2 %>%
  filter(condition == "rich") %$%
  ttestBF(postcond_dp,
          mu = 0,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2,
      y = postcond_dp,
      x = condition,
      mu = 0,
      sub = "rich",
      dir = "greater")

df2 %>%
  filter(condition == "impoverished") %$%
  ttestBF(postcond_dp,
          mu = 0,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df2,
      y = postcond_dp,
      x = condition,
      mu = 0,
      sub = "impoverished",
      dir = "two.sided")

df2 %>%
  as.data.frame() %>%
  ttestBF(data = .,
          formula = postcond_dp ~ condition,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2,
      y = postcond_dp,
      x = condition,
      dir = "greater")

# Graph
df2 %>%
  gather(key = time,
         value = conditionals,
         c(precond_dp, postcond_dp)) %>%
  mutate(time = factor(time,
                       levels = c("precond_dp", "postcond_dp"),
                       labels = c("Pre", "Post"))) %>%
  within_ci(.data = .,
             .subject = participant.id,
             .value = conditionals,
             .ws_factors = time,
             .bs_factors = condition) %>%
  ggplot(aes(color = condition)) +
  geom_point(aes(x = time,
                 y = sample_mean)) +
  geom_line(aes(x = time,
                y = sample_mean,
                group = condition),
            size = .9) +
  geom_errorbar(width = .1,
                aes(x = time,
                    ymin = sample_mean - CI,
                    ymax = sample_mean + CI)) +
  scale_color_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Measurement point",
       y = expression(Delta*"p"))
ggsave("Output/Graphs/Exp2_conditionals.svg", device = "svg")

### Confidence post----

# Inference tests
conf <- df2 %>%
  group_by(condition) %>%
  mutate(conf_post_fr = ifelse(primacy == "A", apostconf2, bpostconf2),
         conf_post_in = ifelse(primacy == "A", bpostconf2, apostconf2)) %>%
  ungroup %>%
  select(condition, conf_post_fr, conf_post_in) %>%
  pivot_longer(df = .,
               cols = c(conf_post_fr, conf_post_in),
               names_to = "type",
               values_to = "confidence")
conf %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)

# Per condition
conf %>%
  filter(condition == "rich") %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  filter(condition == "rich") %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  filter(condition == "rich") %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)

conf %>%
  filter(condition == "impoverished") %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  filter(condition == "impoverished") %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  filter(condition == "impoverished") %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)