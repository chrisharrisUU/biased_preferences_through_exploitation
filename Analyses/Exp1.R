### Setup----
# Dependencies
if (!require(needs)) {install.packages("needs"); library(needs)}
needs(dplyr, magrittr, ggplot2, here, tidyr, BayesFactor, papaja, purrr, lme4, lmerTest)
# library(car)
prioritize(dplyr)

source(here("Auxiliary/Exp1_init.R"))

### Functions----
source(here("Auxiliary/functions.R"))

### Canonical sorting----
df1 <- do_counterbalance_1(df1)

# Include switching
df1 <- switching(df1, 5)

### Demographic data----
# Summary of most relevant demographic data
df1 %>%
  mutate(age = as.integer(as.character(age))) %>%
  summarise(N = n(),
            female = length(which(gender == "female")),
            age_mean = mean(age, na.rm = TRUE),
            age_sd = sd(age, na.rm = TRUE))

# Level of education
df1 %>%
  group_by(edu) %>%
  summarise(count = length(edu))
# Percentage degree
length(which(as.integer(df1$edu) > 2)) / nrow(df1)

### Sampling----

## Comparisons of means

# Graph over trials
time_series(df1)
ggsave("Output/Graphs/Exp1_timeseries.svg", device = "svg")

# Graph
df1 %>%
    ggplot(aes(x = condition,
               y = choiceindex_per,
               fill = condition)) +
    geom_violin() + 
    geom_boxplot(width = 0.2) +
    geom_jitter(size = 0.5, width = 0.2) +
    geom_hline(yintercept = .5, linetype = 2) +
    scale_fill_brewer(palette = "Dark2") +
    theme_apa() +
    labs(x = " ",
         y = "Percentage frequent option over participants") +
    theme(legend.position = "none")
ggsave(filename = "Output/Graphs/Exp1_sampling.svg",
         device = "svg")

# Means and sds
df1 %>%
  group_by(condition) %>%
  summarise(post_avg = printnum(100 * mean(choiceindex_per)),
            post_SD = printnum(100 * sd(choiceindex_per)))

# Tests
df1 %>%
  filter(condition == "rich") %$%
  ttestBF(choiceindex_per,
          mu = .5,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df1,
      y = choiceindex_per,
      x = condition,
      mu = .5,
      sub = "rich",
      dir = "greater")

df1 %>%
  filter(condition == "impoverished") %$%
  ttestBF(choiceindex_per,
          mu = .5,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df1,
      y = choiceindex_per,
      x = condition,
      mu = .5,
      sub = "impoverished",
      dir = "two.sided")

df1 %>%
  mutate(choiceindex_per = ifelse(condition == "rich", choiceindex_per, 1 - choiceindex_per)) %>%
  as.data.frame() %>%
  ttestBF(formula = choiceindex_per ~ condition,
          nullInterval = c(0, Inf),
          data = .) %>%
  printBFt()
df1 %>%
  mutate(choiceindex_per = ifelse(condition == "rich", choiceindex_per, 1 - choiceindex_per)) %>%
  ttest(data = .,
        y = choiceindex_per,
        x = condition,
        dir = "greater")

## Comparisons over trials

# Intercepts
df1 %>%
  cb_lf_int() %>%
  mutate(value = ifelse(condition == "impoverished", value * (-1), value),
         trial = trial - 5) %>%
  mutate(value = ifelse(value < 0, 0, value),
         trial = trial / 100) %>%
  filter(condition == "rich") %>%
  glmer(value ~ 1 + trial + (1|participant.id),
        data = .,
        family = binomial) %>%
  summary()
df1 %>%
  cb_lf_int() %>%
  mutate(value = ifelse(condition == "impoverished", value * (-1), value),
         trial = trial - 5) %>%
  mutate(value = ifelse(value < 0, 0, value),
         trial = trial / 100) %>%
  filter(condition == "impoverished") %>%
  glmer(value ~ 1 + trial + (1|participant.id),
        data = .,
        family = binomial) %>%
  summary()
df1 %>%
  cb_lf_int() %>%
  mutate(value = ifelse(condition == "impoverished", value * (-1), value),
         trial = trial - 5) %>%
  mutate(value = ifelse(value < 0, 0, value),
         trial = trial / 100) %>%
  glmer(value ~ 1 + trial + condition + (1|participant.id),
        data = .,
        family = binomial) %>%
  summary()

# "Main"
df1 %>%
  cb_lf_int() %>%
  mutate(value = ifelse(condition == "impoverished", value * (-1), value),
         trial = trial - 5) %>%
  mutate(value = ifelse(value < 0, 0, value),
         trial = trial / 100) %>%
  glmer(value ~ 1 + (I(trial^2) + trial) * condition + (1|participant.id),
        data = .,
        family = binomial) %>%
  summary()

# "Reversed intercepts"
df1 %>%
  cb_lf_int() %>%
  mutate(value = ifelse(condition == "impoverished", value * (-1), value),
         trial = (trial - 100) * (-1) + 5) %>%
  mutate(value = ifelse(value < 0, 0, value),
         trial = trial / 100) %>%
  filter(condition == "rich") %>%
  glmer(value ~ 1 + trial + (1|participant.id),
        data = .,
        family = binomial) %>%
  summary()
df1 %>%
  cb_lf_int() %>%
  mutate(value = ifelse(condition == "impoverished", value * (-1), value),
         trial = (trial - 100) * (-1) + 5) %>%
  mutate(value = ifelse(value < 0, 0, value),
         trial = trial / 100) %>%
  filter(condition == "impoverished") %>%
  glmer(value ~ 1 + trial + (1|participant.id),
        data = .,
        family = binomial) %>%
  summary()
df1 %>%
  cb_lf_int() %>%
  mutate(value = ifelse(condition == "impoverished", value * (-1), value),
         trial = (trial - 100) * (-1)) %>%
  mutate(value = ifelse(value < 0, 0, value)) %>%
  glmer(value ~ 1 + scale(trial) + condition + (1|participant.id),
        data = .,
        family = binomial) %>%
  summary()

# Difference between groups on first trial
df1 %>%
  select(condition, primacy, week5) %>%
  mutate(week5 = ifelse(primacy == "A", week5 * (-1), week5)) %>%
  mutate(week5 = ifelse(condition == "impoverished", week5 * (-1), week5)) %$%
  table(week5, condition) %>%
  chisq.test()

# Difference between groups on last trial
df1 %>%
  select(condition, primacy, week100) %>%
  mutate(week100 = ifelse(primacy == "A", week100 * (-1), week100)) %>%
  mutate(week100 = ifelse(condition == "impoverished", week100 * (-1), week100)) %$%
  table(week100, condition) %>%
  chisq.test()



# Oscillation
df1 %>%
  oscillations() %>%
  group_by(condition) %>%
  summarize(avg = printnum(100 * mean(oscillation)),
            sd = printnum(100 * sd(oscillation)))
# Graph
oscillations(df1) %>%
  ggplot(aes(x = time,
             y = oscillation,
             color = condition)) +
  geom_point(size = .9) +
  geom_line(size = .2,
            alpha = .3) +
  geom_smooth(method = "loess",
              span = 1,
              size = 1) +
  scale_color_brewer(palette = "Dark2") +
  theme_apa() +
  labs(y = "Percentage switches",
       x = "Trial")
ggsave("Output/Graphs/Exp1_oscillations.svg", device = "svg")

# Test
ttestBF(subset(oscillations(df1), condition == "impoverished")$oscillation,
        subset(oscillations(df1), condition == "rich")$oscillation,
        nullInterval = c(0, Inf)) %>%
  printBFt()
df1 %>%
  oscillations() %>%
  mutate(condition = factor(condition, levels = c("impoverished", "rich"))) %>%
  ttest(data = .,
        y = oscillation,
        x = condition,
        dir = "greater")


### Relative preference estimates----

## Continuous

# Graph
df1 %>%
  ggplot(aes(x = condition,
             y = postpref_freq,
             fill = condition)) +
  geom_violin() + 
  geom_boxplot(width = 0.2) +
  geom_jitter(size = 0.5, width = 0.2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Condition",
       y = "Relative preference esimstes") +
  theme(legend.position = "none")

# Means and sds
df1 %>%
  group_by(condition) %>%
  summarise(post_avg = printnum(mean(postpref_freq)),
            post_SD = printnum(sd(postpref_freq)))

# Tests
df1 %>%
  filter(condition == "rich") %>%
  as.data.frame() %$%
  ttestBF(postpref_freq,
          mu = 0,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df1,
      y = postpref_freq,
      x = condition,
      mu = 0,
      sub = "rich",
      dir = "greater")

df1 %>%
  filter(condition == "impoverished") %>%
  as.data.frame() %$%
  ttestBF(postpref_freq,
          mu = 0,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df1,
      y = postpref_freq,
      x = condition,
      mu = 0,
      sub = "impoverished",
      dir = "two.sided")

df1 %>%
  as.data.frame() %>%
  ttestBF(formula = postpref_freq ~ condition,
          nullInterval = c(0, Inf),
          data = .) %>%
  printBFt()
ttest(data = df1,
      y = postpref_freq,
      x = condition,
      dir = "two.sided")

## Binary

# Make preference binary
df1 %<>%
  mutate(binarypostpref = ifelse(postpref_dom > 0,
                                 1,
                                 ifelse(postpref_dom < 0, 0, NA))) %>%
  mutate(binarypostpref = factor(binarypostpref, levels = c(1, 0)))

# Graph
df1 %>%
  filter(!is.na(binarypostpref)) %>%
  mutate(binarypostpref = factor(binarypostpref)) %>%
  ggplot(aes(x = binarypostpref,
             group = condition,
             fill = condition)) +
  geom_bar(position = "dodge") +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa()

# Distribution
distrpost <- df1 %$%
  table(binarypostpref, condition)
distrpost
length(which(is.na(df1$binarypostpref))) # excluded from binary analyses

# Tests
proportionBF(y = distrpost["1", "rich"],
             N = distrpost["1", "rich"] + distrpost["0", "rich"],
             p = .5,
             rscale = "ultrawide",
             nullInterval = c(.5, 1)) %>% printBFb
binom.test(x = distrpost["1", "rich"],
           n = distrpost["1", "rich"] + distrpost["0", "rich"],
           p = .5,
           alternative = "greater")
proportionBF(y = distrpost["1", "impoverished"],
             N = distrpost["1", "impoverished"] + distrpost["0", "impoverished"],
             p = .5,
             rscale = "ultrawide",
             nullInterval = c(0, 1)) %>% printBFb
binom.test(x = distrpost["1", "impoverished"],
           n = distrpost["1", "impoverished"] + distrpost["0", "impoverished"],
           p = .5,
           alternative = "greater")
proportionBF(y = distrpost["1", "rich"],
             N = distrpost["1", "rich"] + distrpost["0", "rich"],
             p = distrpost["1", "impoverished"] / (distrpost["1", "impoverished"] + distrpost["0", "impoverished"]),
             rscale = "ultrawide",
             nullInterval = c(.5, 1)) %>% printBFb()
binom.test(x = distrpost["1", "rich"],
           n = distrpost["1", "rich"] + distrpost["0", "rich"],
           p = distrpost["1", "impoverished"] / (distrpost["1", "impoverished"] + distrpost["0", "impoverished"]),
           alternative = "greater")

### Conditionals----

# Graph
df1 %>%
  ggplot(aes(x = condition,
             y = postcond_dp,
             fill = condition)) +
  geom_violin() + 
  geom_boxplot(width = 0.2) +
  geom_jitter(size = 0.5, width = 0.2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Conditional estimates",
       y = expression(Delta*"p")) +
  theme(legend.position = "none")

# Summary statistics and tests
df1 %>%
  # xpostcond2 -> How likely was it (in %) that you grabbed a *frequent* ball if...
  mutate(frequent = ifelse(primacy == "A", apostcond2, bpostcond2),
         infrequent = ifelse(primacy == "A", bpostcond2, apostcond2)) %>%
  # Summarize
  group_by(condition) %>%
  summarize(winning_bag = printnum(mean(frequent)),
            losing_bag = printnum(mean(infrequent)),
            winning_bag_sd = printnum(sd(frequent)),
            losing_bag_sd = printnum(sd(infrequent)))

df1 %>%
  group_by(condition) %>%
  summarize(post_avg = printnum(mean(postcond_dp)),
            post_SD = printnum(sd(postcond_dp)))

# Tests
df1 %>%
  filter(condition == "rich") %$%
  ttestBF(postcond_dp,
          mu = 0,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df1,
      y = postcond_dp,
      x = condition,
      mu = 0,
      sub = "rich",
      dir = "greater")

df1 %>%
  filter(condition == "impoverished") %$%
  ttestBF(postcond_dp,
          mu = 0,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df1,
      y = postcond_dp,
      x = condition,
      mu = 0,
      sub = "impoverished",
      dir = "two.sided")

df1 %>%
  as.data.frame() %$%
  ttestBF(formula = postcond_dp ~ condition,
          nullInterval = c(0, Inf),
          data = .) %>%
  printBFt()
ttest(data = df1,
      y = postcond_dp,
      x = condition,
      dir = "greater")

### Confidence----

# Means and sds
df1 %>%
  group_by(condition) %>%
  summarise(post_avg = mean(postconf_dp),
            post_SD = sd(postconf_dp))

### Inference tests
conf <- df1 %>%
  group_by(condition) %>%
  mutate(conf_post_fr = ifelse(primacy == "A", apostconf2, bpostconf2),
         conf_post_in = ifelse(primacy == "A", bpostconf2, apostconf2)) %>%
  ungroup %>%
  select(condition, conf_post_fr, conf_post_in) %>%
  pivot_longer(cols = c(conf_post_fr, conf_post_in),
               names_to = "type",
               values_to = "confidence")
conf %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  ttest(data = .,
      y = confidence,
      x = type,
      dir = "two.sided")
rm(conf)

# Per condition
conf %>%
  filter(condition == "rich") %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  filter(condition == "rich") %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  filter(condition == "rich") %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)

conf %>%
  filter(condition == "impoverished") %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  filter(condition == "impoverished") %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  filter(condition == "impoverished") %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)