### Setup----
# Dependencies
if (!require(needs)) {install.packages("needs"); library(needs)}
if (!require(goallabr)) {
  if (!require(devtools)) {install.packages("devtools"); library(devtools)}
  install_github("chrisharrisUU/goallabr")
}
needs(dplyr, magrittr, ggplot2, here, tidyr, gridExtra, BayesFactor, papaja, purrr, goallabr, lme4, lmerTest, memisc)
prioritize(dplyr)

source(here("Auxiliary/Exp2b_init.R"))

# Fix some participant id entries manually
df2b$participant.id[22] <- 24
df2b$participant.id[76] <- 79
df2b %<>%
  mutate(participant.id = as.integer(participant.id))

### Functions----
source(here("Auxiliary/functions.R"))
# Florians log-Funktion
logbr <- function(ab, cd, ac, bd) {
  return(log10(ab / cd) * log10(ac / bd))
}

### Canonical sorting----
df2b <- do_counterbalance2b(df2b)

# Include switching
df2b <- switching(df2b, 17)

# Make preference binary
df2b %<>%
  mutate(binaryprepref = ifelse(prepref_dom > 0,
                                1,
                                ifelse(prepref_dom < 0, 0, NA)),
         binarypostpref = ifelse(postpref_dom > 0,
                                 1,
                                 ifelse(postpref_dom < 0, 0, NA))) %>%
  mutate(binaryprepref = factor(binaryprepref, levels = c(1, 0)),
         binarypostpref = factor(binarypostpref, levels = c(1, 0)))

### Demographic data----
df2b_dem <- as.data.set(spss.system.file("Data/Exp2b_dem.sav")) %>%
  as.data.frame() %>%
  select(participant.id = ppnummer,
         gender = geslacht,
         age = leeftijd,
         edu = opleiding)
levels(df2b_dem$edu)[levels(df2b_dem$edu) == "Univeristy bachelor"] <- "University bachelor"
df2b %<>% left_join(., df2b_dem, by = "participant.id")


# Summary of most relevant demographic data
df2b %>%
  # mutate(age = as.integer(as.character(age))) %>%
  summarise(N = n(),
            female = length(which(gender == "Female")),
            age_mean = mean(age, na.rm = TRUE),
            age_sd = sd(age, na.rm = TRUE))

# Level of education
df2b %>%
  group_by(edu) %>%
  summarise(count = length(edu))

# Percentage degree
df2b %>%
  mutate(n = n()) %>%
  filter(edu %in% c("University bachelor", "Masters")) %>%
  summarize(higher_ed = n() / mean(n))

### Relative contingency estimates pre----

## Continuous
# Graph
df2b %>%
  ggplot(aes(x = condition,
             y = prepref_freq,
             fill = condition)) +
  geom_violin() + 
  geom_boxplot(width = 0.2) +
  geom_jitter(size = 0.5, width = 0.2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Condition",
       y = "Relative preference estimates - pre-measure") +
  theme(legend.position = "none")

# Means and sds
df2b %>%
  # group_by(condition) %>%
  summarise(pre_avg = printnum(mean(prepref_freq)),
            pre_SD = printnum(sd(prepref_freq)))

# Tests
df2b %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = prepref_freq ~ condition,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = prepref_freq,
      x = condition,
      dir = "two.sided")

ttestBF(
  df2b$prepref_freq,
  mu = 0,
  nullInterval = c(0, Inf)
) %>% printBFt()
ttest(data = df2b,
      y = prepref_freq,
      x = condition,
      mu = 0,
      dir = "greater")

## Binary
# Distribution
distrpre <- df2b %$%
  table(binaryprepref, condition)
distrpre
length(which(is.na(df2b$binaryprepref))) # excluded from binary analyses

# Tests
proportionBF(y = distrpre["1", "rich"],
             N = distrpre["1", "rich"] + distrpre["0", "rich"],
             p = distrpre["0", "impoverished"] / (distrpre["1", "impoverished"] + distrpre["0", "impoverished"]),
             rscale = "ultrawide",
             nullInterval = c(0, 1)) %>% printBFb()
binom.test(x = distrpre["1", "rich"],
           n = distrpre["1", "rich"] + distrpre["0", "rich"],
           p = distrpre["0", "impoverished"] / (distrpre["1", "impoverished"] + distrpre["0", "impoverished"]),
           alternative = "greater")

proportionBF(y = distrpre["1", "rich"] + distrpre["0", "impoverished"],
             N = distrpre["1", "rich"] + distrpre["0", "rich"] + distrpre["1", "impoverished"] + distrpre["0", "impoverished"],
             p = .5,
             rscale = "ultrawide",
             nullInterval = c(0, 1)) %>% printBFb()
binom.test(x = distrpre["1", "rich"] + distrpre["0", "impoverished"],
           n = distrpre["1", "rich"] + distrpre["0", "rich"] + distrpre["1", "impoverished"] + distrpre["0", "impoverished"],
           p = .5,
           alternative = "greater")

### Baserates pre----
df2b %>%
  group_by(condition) %>%
  summarize(log_mean = printnum(mean(prebr)),
            log_sd   = printnum(sd(prebr)))

# Summary statistics and tests
df2b %>%
  summarize(frequent_bag       = printnum(mean(preab)),
            infrequent_bag     = printnum(mean(precd)),
            frequent_outcome   = printnum(mean(preac)),
            infrequent_outcome = printnum(mean(prebd)))
df2b %>%
  summarize(frequent_bag_sd       = printnum(sd(preab)),
            infrequent_bag_sd     = printnum(sd(precd)),
            frequent_outcome_sd   = printnum(sd(preac)),
            infrequent_outcome_sd = printnum(sd(prebd)))

# Tests
df2b %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = prebr ~ condition,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = prebr,
      x = condition,
      dir = "two.sided")

ttestBF(df2b$prebr, mu = 0, nullInterval = c(0, Inf)) %>% printBFt()
ttest(data = df2b,
      y = prebr,
      x = condition,
      mu = 0,
      dir = "greater")

### Conditionals pre----
# Graph
df2b %>%
  ggplot(aes(x = condition,
             y = precond_dp,
             fill = condition)) +
  geom_violin() +
  geom_boxplot(width = 0.2) +
  geom_jitter(size = 0.5, width = 0.2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Conditional estimates",
       y = expression(Delta*"p")) +
  theme(legend.position = "none")

# Summary statistics and tests
df2b %>%
  # xprecond2 -> How likely was it (in %) that you grabbed a *frequent* ball if...
  mutate(frequent = ifelse(primacy == "A", aprecond2, bprecond2),
         infrequent = ifelse(primacy == "A", bprecond2, aprecond2)) %>%
  # Summarize
  # group_by(condition) %>%
  summarize(pre_winning_rich = printnum(mean(frequent)),
            pre_losing_rich = printnum(mean(infrequent)),
            winning_bag_sd = printnum(sd(frequent)),
            losing_bag_sd = printnum(sd(infrequent)))

df2b %>%
  group_by(condition) %>%
  summarize(post_avg = printnum(mean(precond_dp)),
            post_SD = printnum(sd(precond_dp)))

# Tests
df2b %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = precond_dp ~ condition,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = precond_dp,
      x = condition,
      dir = "two.sided")

ttestBF(df2b$precond_dp, mu = 0, nullInterval = c(0, Inf)) %>% printBFt()
ttest(data = df2b,
      y = precond_dp,
      x = condition,
      mu = 0,
      dir = "greater")

### Confidence pre ----

# Means and sds
df2b %>%
  group_by(condition) %>%
  summarise(pre_avg = printnum(mean(preconf_dp)),
            pre_SD = printnum(sd(preconf_dp)))

# Inference tests
conf <- df2b %>%
  group_by(condition) %>%
  mutate(conf_pre_fr = ifelse(primacy == "A", apreconf2, bpreconf2),
         conf_pre_in = ifelse(primacy == "A", bpreconf2, apreconf2)) %>%
  ungroup %>%
  select(condition, conf_pre_fr, conf_pre_in) %>%
  pivot_longer(cols = c(conf_pre_fr, conf_pre_in),
               names_to = "type",
               values_to = "confidence")
conf %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)

# Per condition
conf %>%
  filter(condition == "rich") %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  filter(condition == "rich") %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  filter(condition == "rich") %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)

conf %>%
  filter(condition == "impoverished") %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  filter(condition == "impoverished") %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  filter(condition == "impoverished") %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)
### Sampling----

## Comparison of means

# Graph
time_series(df2b)
ggsave("Output/Graphs/Exp2b_timeseries.svg", device = "svg")

# Graph
df2b %>%
    ggplot(aes(x = condition,
               y = choiceindex_per,
               fill = condition)) +
    geom_violin() +
    geom_boxplot(width = 0.2) +
    geom_jitter(size = 0.5, width = 0.2) +
    geom_hline(yintercept = .5, linetype = 2) +
    scale_fill_brewer(palette = "Dark2") +
    theme_apa() +
    labs(x = " ",
         y = "Percentage frequent option over participants") +
    theme(legend.position = "none")
ggsave(filename = "Output/Graphs/Exp2b_sampling.svg",
       device = "svg") # 9.08 x 5.72

# Means and sds
df2b %>%
  group_by(condition) %>%
  summarise(post_avg = printnum(100 * mean(choiceindex_per)),
            post_SD = printnum(100 * sd(choiceindex_per)))

# Tests
df2b %>%
  filter(condition == "rich") %>%
  as.data.frame() %$%
  ttestBF(choiceindex_per,
          mu = .5,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = choiceindex_per,
      x = condition,
      mu = .5,
      sub = "rich",
      dir = "greater")

df2b %>%
  filter(condition == "impoverished") %>%
  as.data.frame() %$%
  ttestBF(choiceindex_per,
          mu = .5,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt(dir = "01")
ttest(data = df2b,
      y = choiceindex_per,
      x = condition,
      mu = .5,
      sub = "impoverished",
      dir = "two.sided")

df2b %>%
  mutate(choiceindex_per = ifelse(condition == "rich", choiceindex_per, 1 - choiceindex_per)) %>%
  as.data.frame() %>%
  ttestBF(data = .,
          formula = choiceindex_per ~ condition,
          nullInterval = c(0, Inf)) %>%
  printBFt()
df2b %>%
  mutate(choiceindex_per = ifelse(condition == "rich", choiceindex_per, 1 - choiceindex_per)) %>%
  ttest(data = .,
        y = choiceindex_per,
        x = condition,
        dir = "greater")

## Comparisons over trials

# Linear model
mod2b <- df2b %>%
  cb_lf_int() %>%
  mutate(trial = trial - 17,
         condition = relevel(condition, ref = "impoverished")) %>%
  mutate(value = ifelse(value < 0, 0, value),
         trial = trial / 100) %>%
  glmer(value ~ 1 + trial * condition + (1|participant.id),
        data = .,
        family = binomial)

# Plot
expand.grid(c(0, 1),  17:100 - 17) %>%
  rename(condition = Var1,
         trial = Var2) %>%
  mutate(y_binom = mod2b@beta[1] + (trial / 100) * mod2b@beta[2] + condition * mod2b@beta[3] + (trial / 100) * condition * mod2b@beta[4]) %>%
  mutate(y_prob = exp(y_binom) / (1 + exp(y_binom))) %>%
  ggplot() +
  geom_point(aes(y = y_prob,
                 x = trial,
                 group = condition)) +
  geom_hline(aes(yintercept = .5), linetype = "dashed")

# Output
mod2b %>%
  summary()

# Shifted linear model
mod2bs <- df2b %>%
  cb_lf_int() %>%
  mutate(trial = trial - 117,
         condition = relevel(condition, ref = "impoverished")) %>%
  mutate(value = ifelse(value < 0, 0, value),
         trial = trial / 100) %>%
  glmer(value ~ 1 + trial * condition + (1|participant.id),
        data = .,
        family = binomial)

# Output
mod2bs %>%
  summary()

# # Quadratic model
# mod_quad2b <- df2b %>%
#   cb_lf_int() %>%
#   mutate(trial = trial - 17) %>%
#   mutate(value = ifelse(value < 0, 0, value),
#          trial = trial / 100) %>%
#   glmer(value ~ 1 + (I(trial^2) + trial) * condition + (1|participant.id),
#         data = .,
#         family = binomial)
# # Output
# mod_quad2b %>%
#   summary
# # Plot
# expand.grid(c(0, 1),  17:100 - 17) %>%
#   rename(condition = Var1,
#          trial = Var2) %>%
#   mutate(y_binom = mod_quad2b@beta[1] + ((trial / 100)^2) * mod_quad2b@beta[2] + (trial / 100) * mod_quad2b@beta[3] +
#            condition * mod_quad2b@beta[4] + ((trial / 100)^2) * condition * mod_quad2b@beta[5] +
#            (trial / 100) * condition * mod_quad2b@beta[6]) %>%
#   mutate(y_prob = exp(y_binom) / (1 + exp(y_binom))) %>%
#   ggplot() +
#   geom_point(aes(y = y_prob,
#                  x = trial,
#                  group = condition)) +
#   geom_hline(aes(yintercept = .5), linetype = "dashed")
# # Model comparison
# anova(mod2b, mod_quad2b, test = "Chisq")

## Oscillation
oscillations(df2b) %>%
  group_by(condition) %>%
  summarize(avg = 100 * mean(oscillation),
            sd = 100 * sd(oscillation))

oscillations(df2b) %>%
  ggplot(aes(x = time,
             y = oscillation,
             color = condition)) +
  geom_point(size = .9) +
  geom_line(size = .2,
            alpha = .3) +
  geom_smooth(method = "loess",
              span = 1,
              size = 1) +
  scale_color_brewer(palette = "Dark2") +
  theme_apa() +
  labs(y = "Percentage switches",
       x = "Trial")
ggsave("Output/Graphs/Exp2b_oscillations.svg", device = "svg")

# Test
ttestBF(subset(oscillations(df2b), condition == "impoverished")$oscillation,
        subset(oscillations(df2b), condition == "rich")$oscillation,
        nullInterval = c(0, Inf)) %>%
  printBFt()
df2b %>%
  oscillations() %>%
  mutate(condition = factor(condition, levels = c("impoverished", "rich"))) %>%
  ttest(data = .,
        y = oscillation,
        x = condition,
        dir = "greater")

### Relative contingency estimates post----

## Continuous

# Graph
df2b %>%
  ggplot(aes(x = condition,
             y = postpref_freq,
             fill = condition)) +
  geom_violin() +
  geom_boxplot(width = 0.2) +
  geom_jitter(size = 0.5, width = 0.2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Condition",
       y = "Relative preference estimates - post-measure") +
  theme(legend.position = "none")

# Means and sds
df2b %>%
  group_by(condition) %>%
  summarise(post_avg = printnum(mean(postpref_freq)),
            post_SD = printnum(sd(postpref_freq)))

# Tests
df2b %>%
  filter(condition == "rich") %>%
  as.data.frame() %$%
  ttestBF(postpref_freq,
          mu = 0,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = postpref_freq,
      x = condition,
      mu = 0,
      sub = "rich",
      dir = "greater")

df2b %>%
  filter(condition == "impoverished") %>%
  as.data.frame() %$%
  ttestBF(postpref_freq,
          mu = 0,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = postpref_freq,
      x = condition,
      mu = 0,
      sub = "impoverished",
      dir = "two.sided")

df2b %>%
  as.data.frame() %>%
  ttestBF(data = .,
          formula = postpref_freq ~ condition,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = postpref_freq,
      x = condition,
      dir = "greater")

# Graph
df2b %>%
  gather(key = time,
         value = polarity,
         c(prepref_freq, postpref_freq)) %>%
  mutate(time = factor(time,
                       levels = c("prepref_freq", "postpref_freq"),
                       labels = c("pre", "post"))) %>%
  within_ci(data = .,
            subject = participant.id,
            value = polarity,
            ws_factors = time,
            bs_factors = condition) %>%
  ggplot(aes(color = condition)) +
  geom_point(aes(x = time,
                 y = sample_mean)) +
  geom_line(aes(x = time,
                y = sample_mean,
                group = condition),
            size = .9) +
  geom_errorbar(width = .1,
                aes(x = time,
                    ymin = sample_mean - CI,
                    ymax = sample_mean + CI)) +
  scale_color_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Measurement point",
       y = "Relative preference estimates")
ggsave("Output/Graphs/Exp2b_relprefest.svg", device = "svg")

## Binary

# Graph
df2b %>%
  filter(!is.na(binarypostpref)) %>%
  mutate(binarypostpref = factor(binarypostpref)) %>%
  ggplot(aes(x = binarypostpref,
             group = condition,
             fill = condition)) +
  geom_bar(position = "dodge") +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa()


# Distribution
distrpost <- df2b %$%
  table(binarypostpref, condition)
distrpost
length(which(is.na(df2b$binarypostpref))) # excluded from binary analyses

# Tests
proportionBF(y = distrpost["1", "rich"],
             N = distrpost["1", "rich"] + distrpost["0", "rich"],
             p = .5,
             rscale = "ultrawide",
             nullInterval = c(.5, 1)) %>% printBFb
binom.test(x = distrpost["1", "rich"],
           n = distrpost["1", "rich"] + distrpost["0", "rich"],
           p = .5,
           alternative = "greater")

proportionBF(y = distrpost["0", "impoverished"],
             N = distrpost["1", "impoverished"] + distrpost["0", "impoverished"],
             p = .5,
             rscale = "ultrawide",
             nullInterval = c(0, 1)) %>% printBFb
binom.test(x = distrpost["0", "impoverished"],
           n = distrpost["1", "impoverished"] + distrpost["0", "impoverished"],
           p = .5,
           alternative = "greater")

proportionBF(y = distrpost["1", "rich"],
             N = distrpost["1", "rich"] + distrpost["0", "rich"],
             p = distrpost["0", "impoverished"] / (distrpost["1", "impoverished"] + distrpost["0", "impoverished"]),
             rscale = "ultrawide",
             nullInterval = c(.5, 1)) %>% printBFb()
binom.test(x = distrpost["1", "rich"],
           n = distrpost["1", "rich"] + distrpost["0", "rich"],
           p = distrpost["0", "impoverished"] / (distrpost["1", "impoverished"] + distrpost["0", "impoverished"]),
           alternative = "greater")


### Baserates post----
df2b %>%
  group_by(condition) %>%
  summarize(log_mean = printnum(mean(postbr)),
            log_sd = printnum(sd(postbr)))

# Summary statistics and tests
df2b %>%
  group_by(condition) %>%
  summarize(frequent_bag       = printnum(mean(postab)),
            infrequent_bag     = printnum(mean(postcd)),
            frequent_outcome   = printnum(mean(postac)),
            infrequent_outcome = printnum(mean(postbd)))
df2b %>%
  summarize(frequent_bag_sd       = printnum(sd(postab)),
            infrequent_bag_sd     = printnum(sd(postcd)),
            frequent_outcome_sd   = printnum(sd(postac)),
            infrequent_outcome_sd = printnum(sd(postbd)))

# Correlations
df2b %>%
  group_by(condition) %>%
  summarize(sampling = cor(postbr, choiceindex_per),
            estimates = cor(postbr, postpref_freq))

# Tests
df2b %>%
  filter(condition == "rich") %$%
  ttestBF(postbr,
          mu = 0,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = postbr,
      x = condition,
      mu = 0,
      sub = "rich",
      dir = "greater")

df2b %>%
  filter(condition == "impoverished") %$%
  ttestBF(postbr,
          mu = 0,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
df2b %>%
  ttest(data = .,
      y = postbr,
      x = condition,
      mu = 0,
      sub = "impoverished",
      dir = "two.sided")

df2b %>%
  mutate(postbr = ifelse(condition == "impoverished", postbr * (-1), postbr)) %>%
  as.data.frame() %>%
  ttestBF(data = .,
          formula = postbr ~ condition,
          nullInterval = c(0, Inf)) %>%
  printBFt()
df2b %>%
  mutate(postbr = ifelse(condition == "impoverished", postbr * (-1), postbr)) %>%
  ttest(data = .,
      y = postbr,
      x = condition,
      dir = "greater")

# Graph
df2b %>%
  gather(key = time,
         value = br,
         c(prebr, postbr)) %>%
  mutate(time = factor(time,
                       levels = c("prebr", "postbr"),
                       labels = c("Pre", "Post"))) %>%
  within_ci(data = .,
            subject = participant.id,
            value = br,
            ws_factors = time,
            bs_factors = condition) %>%
  ggplot(aes(color = condition)) +
  geom_point(aes(x = time,
                 y = sample_mean)) +
  geom_line(aes(x = time,
                y = sample_mean,
                group = condition),
            size = .9) +
  geom_errorbar(width = .1,
                aes(x = time,
                    ymin = sample_mean - CI,
                    ymax = sample_mean + CI)) +
  scale_color_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Measurement point",
       y = "log")
ggsave("Output/Graphs/Exp2b_baserates.svg", device = "svg")

# Correlations
df2b %>%
  group_by(condition) %>%
  summarize(sampling     = printnum(cor(postbr, choiceindex_per)),
            conditionals = printnum(cor(postbr, postcond_dp)))
### Conditionals post----

# Graph
df2b %>%
  ggplot(aes(x = condition,
             y = postcond_dp,
             fill = condition)) +
  geom_violin() +
  geom_boxplot(width = 0.2) +
  geom_jitter(size = 0.5, width = 0.2) +
  geom_hline(yintercept = 0, linetype = 2) +
  scale_fill_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Conditional estimates",
       y = expression(Delta*"p")) +
  theme(legend.position = "none")

# Summary statistics and tests
df2b %>%
  # xpostcond2 -> How likely was it (in %) that you grabbed a *frequent* ball if...
  mutate(frequent = ifelse(primacy == "A", apostcond2, bpostcond2),
         infrequent = ifelse(primacy == "A", bpostcond2, apostcond2)) %>%
  # Summarize
  group_by(condition) %>%
  summarise(winning_bag = printnum(mean(frequent)),
            losing_bag = printnum(mean(infrequent)),
            winning_bag_sd = printnum(sd(frequent)),
            losing_bag_sd = printnum(sd(infrequent)))

df2b %>%
  group_by(condition) %>%
  summarise(post_avg = printnum(mean(postcond_dp)),
            post_SD = printnum(sd(postcond_dp)))

# Tests
df2b %>%
  filter(condition == "rich") %$%
  ttestBF(postcond_dp,
          mu = 0,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = postcond_dp,
      x = condition,
      mu = 0,
      sub = "rich",
      dir = "greater")

df2b %>%
  filter(condition == "impoverished") %$%
  ttestBF(postcond_dp,
          mu = 0,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = postcond_dp,
      x = condition,
      mu = 0,
      sub = "impoverished",
      dir = "two.sided")

df2b %>%
  as.data.frame() %>%
  ttestBF(data = .,
          formula = postcond_dp ~ condition,
          nullInterval = c(0, Inf)) %>%
  printBFt()
ttest(data = df2b,
      y = postcond_dp,
      x = condition,
      dir = "greater")

# Graph
df2b %>%
  gather(key = time,
         value = conditionals,
         c(precond_dp, postcond_dp)) %>%
  mutate(time = factor(time,
                       levels = c("precond_dp", "postcond_dp"),
                       labels = c("Pre", "Post"))) %>%
  within_ci(data = .,
            subject = participant.id,
            value = conditionals,
            ws_factors = time,
            bs_factors = condition) %>%
  ggplot(aes(color = condition)) +
  geom_point(aes(x = time,
                 y = sample_mean)) +
  geom_line(aes(x = time,
                y = sample_mean,
                group = condition),
            size = .9) +
  geom_errorbar(width = .1,
                aes(x = time,
                    ymin = sample_mean - CI,
                    ymax = sample_mean + CI)) +
  scale_color_brewer(palette = "Dark2") +
  theme_apa() +
  labs(x = "Measurement point",
       y = expression(Delta*"p"))
ggsave("Output/Graphs/Exp2b_conditionals.svg", device = "svg")

### Confidence post----

# Means and sds
df2b %>%
  group_by(condition) %>%
  summarise(post_avg = printnum(mean(postconf_dp)),
            post_SD = printnum(sd(postconf_dp)))

# Inference tests
conf <- df2b %>%
  group_by(condition) %>%
  mutate(conf_post_fr = ifelse(primacy == "A", apostconf2, bpostconf2),
         conf_post_in = ifelse(primacy == "A", bpostconf2, apostconf2)) %>%
  ungroup %>%
  select(condition, conf_post_fr, conf_post_in) %>%
  pivot_longer(cols = c(conf_post_fr, conf_post_in),
               names_to = "type",
               values_to = "confidence")
conf %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)

# Per condition
conf %>%
  filter(condition == "rich") %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  filter(condition == "rich") %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  filter(condition == "rich") %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)

conf %>%
  filter(condition == "impoverished") %>%
  group_by(type) %>%
  summarize(avg = printnum(mean(confidence)),
            sd = printnum(sd(confidence)))
conf %>%
  filter(condition == "impoverished") %>%
  as.data.frame() %$%
  ttestBF(data = .,
          formula = confidence ~ type,
          nullInterval = c(-Inf, Inf)) %>%
  printBFt()
conf %>%
  filter(condition == "impoverished") %>%
  ttest(data = .,
        y = confidence,
        x = type,
        dir = "two.sided")
rm(conf)