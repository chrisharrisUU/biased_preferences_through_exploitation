### Data import
source(here("Auxiliary/Exp1_import.r"))
rm(as.data.frame.avector, `[.avector`)

# Remove not completed cases
data1 %<>%
  filter(LASTPAGE == 14)

# Rename and create dataframe
column.rename <- function(.data) {
  # Prolific ID
  # Self-report
  participant.id <- .data %>%
    transmute(participant.id  = ifelse(grepl("@", DM01_01),
                                       substr(DM01_01, start = 1, stop = regexpr("@", DM01_01) - 1),
                                       DM01_01))
  # Read out from link
  session_id <- .data %>%
    transmute(id = as.character(substr(IV01_REF, start = 37, stop = 100)))
  # Counterbalancing
  # condition (rich vs impoverished)
  # primacy (A vs B)
  # winning color (yellow vs blue)
  # direction of question (yellow vs blue)
  # 1 rAyy  5 rByy   9 pAyy   13 pByy
  # 2 rAyb  6 rByb  10 pAyb   14 pByb
  # 3 rAby  7 rBby  11 pAby   15 pBby
  # 4 rAbb  8 rBbb  12 pAbb   16 pBbb
  
  # Condition
  # 1 -> rich, 75% wins
  # 2 -> impoverished, 75% losses
  condition <- .data %>%
    transmute(condition = ifelse(UR01 < 9, 1, 2)) %>%
    mutate(condition = factor(condition, levels = c(1,2), labels = c("rich", "impoverished")))
  # Primacy
  primacy <- .data %>%
    transmute(primacy = ifelse(UR01 %in% c(1:4, 9:12), -1, 1)) %>%
    mutate(primacy = factor(primacy, levels = c(-1,1), labels = c("A", "B")))
  # Winning
  winning <- .data %>%
    transmute(winning = ifelse(UR01 %in% c(1, 2, 5, 6, 9, 10, 13, 14), -1, 1)) %>%
    mutate(winning = factor(winning, levels = c(-1,1), labels = c("yellow", "blue")))
  # Direction
  direction <- .data %>%
    transmute(direction = ifelse(UR01 %in% c(1, 3, 5, 7, 9, 11, 13, 15), -1, 1)) %>%
    mutate(direction = factor(direction, levels = c(-1,1), labels = c("yellow", "blue")))
  # Full info
  levelnames <- attributes(data1$UR01) %>%
    unlist
  # levelnames[1] <- "rAyy"
  # levelnames[7] <- "rBby"
  counterbalancing <- data1$UR01 %>%
    factor(levels = 1:16, labels = levelnames[1:16])
  
  
  # Points earned
  account <- as.integer(as.character(.data$IV02_02))
  
  # Choices in free selection phase
  freeselection <- .data %>%
    select(contains("TR02")) %>%
    select(everything(), -contains("a")) %>%
    mutate_all(funs(((function(x) {
      x <- gsub("sackA.svg", -1, x)
      x <- gsub("sackB.svg", 1, x)
      x %>%
        as.integer %>%
        return
    })(.))))
  # Assign useful column names
  colnames(freeselection) <- paste("week", 5:100, sep = "")
  # Create selection index
  freeselection <- freeselection %>%
    mutate(choiceindex_raw = rowSums(., na.rm = TRUE))
  
  # # Initial DVs
  # # Preference
  # prepref_raw <- .data %>%
  #   transmute(adjusted = DV01_01 - 1) %>%
  #   unlist
  # # Conditionals
  # precond_raw <- .data %>%
  #   transmute(a_precond = DV03_01 - 1,
  #             b_precond = DV03_02 - 1)
  # # Confidence
  # preconf_raw <- .data %>%
  #   transmute(a_preconf = DV05_01 - 1,
  #             b_preconf = DV05_02 - 1)
  
  # Second DVs
  # Preference
  postpref_raw <- .data %>%
    transmute(adjusted = DV02_01 - 1) %>%
    unlist
  # Conditionals
  postcond_raw <- .data %>%
    transmute(a_postcond = DV04_01 - 1,
              b_postcond = DV04_02 - 1)
  # Confidence
  postconf_raw <- .data %>%
    transmute(a_postconf = DV06_01 - 1,
              b_postconf = DV06_02 - 1)
  
  # Demographics
  dem <- .data %>%
    select(age = DM03,
           gender = DM04,
           psych = DM05,
           attcheck = DM02,
           edu = DM06)
  
  # Return dataframe
  data.frame(participant.id, session_id,
             counterbalancing, condition, primacy, winning, direction, account,
             # prepref_raw, precond_raw, preconf_raw,
             freeselection,
             postpref_raw, postcond_raw, postconf_raw,
             dem) %>%
    as_tibble() %>%
    return
}
df1 <- column.rename(data1)
rm(column.rename)

# Delete cases with too many missing choices
df1$choiceNAs <- df1 %>%
  select(contains("week")) %>%
  apply(., 2, function(x) {
    y <- rep(0, length(x))
    y[which(is.na(x))] <- 1
    y
  }) %>%
  rowSums
excluded <- which(df1$choiceNAs > 10)
df1 %<>%
  filter(choiceNAs < 10)

# Counterbalancing

# condition (rich vs impoverished)
# primacy (A vs B)
# winning color (yellow vs blue)
# direction of question (yellow vs blue)
# A |-------| B

do_counterbalance_1 <- function(df) {
  df %>%
    mutate(
      # This is the opposite of winning
      not_winning_color = ifelse(winning == "blue", "yellow", "blue")
    ) %>%
    mutate(
      # This is the color that was featured frequently
      freq_color = ifelse(condition == "rich", as.character(winning), not_winning_color)
    ) %>%
    mutate(
      # Add dummy variables
      quest_dir = ifelse(freq_color == direction, 1, 0)
    ) %>%
    mutate(
      # Add dummy variables
      quest_dir = factor(quest_dir)
    ) %>%
    mutate(
      # Everything as if asked from yellow's perspective
      postpref1 = ifelse(direction == "yellow", postpref_raw, 100 - postpref_raw),
      apostcond1 = ifelse(direction == "yellow", a_postcond, 100 - a_postcond),
      bpostcond1 = ifelse(direction == "yellow", b_postcond, 100 - b_postcond),
      apostconf1 = ifelse(direction == "yellow", a_postconf, 100 - a_postconf),
      bpostconf1 = ifelse(direction == "yellow", b_postconf, 100 - b_postconf)
    ) %>%
    mutate(
      # Everything asked from frequent
      postpref2 = ifelse(freq_color == "yellow", postpref1, 100 - postpref1),
      apostcond2 = ifelse(freq_color == "yellow", apostcond1, 100 - apostcond1),
      bpostcond2 = ifelse(freq_color == "yellow", bpostcond1, 100 - bpostcond1),
      apostconf2 = ifelse(freq_color == "yellow", apostconf1, 100 - apostconf1),
      bpostconf2 = ifelse(freq_color == "yellow", bpostconf1, 100 - bpostconf1)
    ) %>%
    mutate(
      # Collapse primacy
      postpref3 = ifelse(primacy == "B", postpref2, 100 - postpref2),
      postcond_1 = ifelse(primacy == "A", apostcond2 - bpostcond2, bpostcond2 - apostcond2),
      postconf_1 = ifelse(primacy == "A", apostconf2 - bpostconf2, bpostconf2 - apostconf2),
      choiceindex_freq = ifelse(primacy == "A", choiceindex_raw * (-1), choiceindex_raw)
    ) %>%
    mutate(
      # Shift from 0 - 100 to -50 to 50 and deltaps to -1, 1
      postpref_freq = postpref3 - 50,
      postcond_dp = postcond_1 / 100,
      postconf_dp = postconf_1 / 100
    ) %>%
    mutate(
      # Dominant coding for interaction effects: Flip negative condition
      postpref_dom = ifelse(condition == "rich", postpref_freq, postpref_freq * (-1)),
      choiceindex_dom = ifelse(condition == "rich", choiceindex_freq, choiceindex_freq * (-1)),
      postcond_dp_dom = ifelse(condition == "rich", postcond_dp, postcond_dp * (-1))) %>%
    mutate(
      # Sampling as percentage
      choiceindex_per = (choiceindex_freq + 96) / (96 * 2)
    )
}